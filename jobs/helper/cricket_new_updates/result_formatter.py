"""
Result Formatting and File Output for Cricket Predictions
"""

import os
import json
from datetime import datetime
from typing import Dict, List


def write_to_result_file(content: str, is_header: bool = False):
    """Write content to result file with proper formatting and append mode."""
    try:
        # Create result file if it doesn't exist
        if not os.path.exists("result"):
            with open("result", "w", encoding="utf-8") as f:
                f.write("CRICKET MATCH PREDICTION ANALYSIS LOG\n")
                f.write("=" * 80 + "\n")
                f.write(f"Generated by Enhanced Cricket Prediction System\n")
                f.write(f"First run: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write("=" * 80 + "\n\n")
        
        # Append new content
        with open("result", "a", encoding="utf-8") as f:
            if is_header:
                f.write("\n" + "=" * 80 + "\n")
                f.write(content + "\n")
                f.write("=" * 80 + "\n")
            else:
                f.write(content + "\n")
                
    except Exception as e:
        print(f"âš ï¸ Warning: Could not write to result file: {e}")


def format_prediction_for_result(result: Dict, date_input: str) -> str:
    """Format prediction result with AI summary for readable result file."""
    match_info = result['match_info']
    scores = result['scores']
    
    result_lines = []
    result_lines.append(f"MATCH {result['match_number']}: {match_info['teams']['team_a']} vs {match_info['teams']['team_b']}")
    result_lines.append("-" * 60)
    result_lines.append(f"ğŸ“… Date: {date_input}")
    result_lines.append(f"ğŸ—ï¸  Match Key: {match_info['match_key']}")
    result_lines.append(f"ğŸŸï¸  Tournament: {match_info['tournament']}")
    result_lines.append(f"ğŸ“ Venue: {match_info['venue']}")
    result_lines.append(f"â° Time: {match_info['match_time']}")
    result_lines.append(f"ğŸ® Format: {match_info['format']}")
    result_lines.append(f"ğŸ“Š Status: {match_info['status']}")
    result_lines.append(f"ğŸ“Š Data Quality: {scores['data_availability']} fields available")
    result_lines.append(f"ğŸ“Š Similarity Score: {scores['similarity_score']:.2f}")
    result_lines.append(f"ğŸ“Š Confidence Level: {scores['confidence_level'].upper()}")
    result_lines.append("")
    
    # Parse and display prediction details
    try:
        prediction = json.loads(result['prediction'])
        if 'prediction_flag' in prediction:
            result_lines.append(f"ğŸš© Prediction Flag: {prediction['prediction_flag']}")
        result_lines.append("") # Adds a nice space in the output

        if 'prediction' in prediction and 'error' not in prediction:
            winner_team = match_info['teams']['team_a'] if prediction['prediction']['winner'] == 'A' else match_info['teams']['team_b']
            win_percentage = prediction['prediction']['a_win_pct'] if prediction['prediction']['winner'] == 'A' else prediction['prediction']['b_win_pct']
            
            result_lines.append(f"ğŸ¯ PREDICTION RESULT:")
            result_lines.append(f"   Winner: {winner_team} ({win_percentage}% chance)")
            result_lines.append(f"   Win Probabilities:")
            result_lines.append(f"     â€¢ {match_info['teams']['team_a']}: {prediction['prediction']['a_win_pct']}%")
            result_lines.append(f"     â€¢ {match_info['teams']['team_b']}: {prediction['prediction']['b_win_pct']}%")
            result_lines.append("")

            # === ADD AI SUMMARY DISPLAY ===
            if 'ai_summary' in prediction and prediction['ai_summary'].get('text'):
                result_lines.append("ğŸ¤– AI ANALYSIS SUMMARY:")
                result_lines.append(f"   {prediction['ai_summary']['text']}")
                result_lines.append("")
            
            # Add supporting analysis if available
            if 'supporting' in prediction:
                supporting = prediction['supporting']
                result_lines.append("ğŸ“‹ SUPPORTING ANALYSIS:")
                
                if supporting.get('recent_form_summary') and supporting['recent_form_summary'] != "Data unavailable":
                    result_lines.append(f"   Recent Form: {supporting['recent_form_summary']}")
                
                if supporting.get('h2h_summary') and supporting['h2h_summary'] != "Data unavailable":
                    result_lines.append(f"   Head-to-Head: {supporting['h2h_summary']}")
                
                if supporting.get('venue_analysis') and supporting['venue_analysis'] != "Data unavailable":
                    result_lines.append(f"   Venue Analysis: {supporting['venue_analysis']}")
                
                if supporting.get('key_players_a') and len(supporting['key_players_a']) > 0:
                    result_lines.append(f"   Key Players ({match_info['teams']['team_a']}): {', '.join(supporting['key_players_a'])}")
                
                if supporting.get('key_players_b') and len(supporting['key_players_b']) > 0:
                    result_lines.append(f"   Key Players ({match_info['teams']['team_b']}): {', '.join(supporting['key_players_b'])}")
                
                if supporting.get('weather_conditions') and supporting['weather_conditions'] != "Data unavailable":
                    result_lines.append(f"   Weather: {supporting['weather_conditions']}")
                
                if supporting.get('pitch_conditions') and supporting['pitch_conditions'] != "Data unavailable":
                    result_lines.append(f"   Pitch: {supporting['pitch_conditions']}")
                
                result_lines.append("")
            
            # Add explanation
            if 'explanation' in prediction:
                result_lines.append("ğŸ’¡ DETAILED EXPLANATION:")
                result_lines.append(f"   {prediction['explanation']}")
                result_lines.append("")
            
            # Add betting recommendation if available
            if 'betting_recommendation' in prediction:
                result_lines.append("ğŸ’° BETTING INSIGHTS:")
                result_lines.append(f"   {prediction['betting_recommendation']}")
                result_lines.append("")
            
            # Add risk factors if available
            if 'risk_factors' in prediction:
                result_lines.append("âš ï¸ RISK FACTORS:")
                result_lines.append(f"   {prediction['risk_factors']}")
                result_lines.append("")
        else:
            result_lines.append(f"âŒ PREDICTION ERROR:")
            result_lines.append(f"   {prediction.get('error', 'Unknown error occurred')}")
            result_lines.append("")
            
    except json.JSONDecodeError:
        result_lines.append("âŒ Could not parse prediction data")
        result_lines.append("")
    
    # Add full JSON for reference
    result_lines.append("ğŸ“„ COMPLETE PREDICTION JSON:")
    try:
        parsed_prediction = json.loads(result['prediction'])
        formatted_json = json.dumps(parsed_prediction, indent=2, ensure_ascii=False)
        for line in formatted_json.split('\n'):
            result_lines.append(f"   {line}")
    except:
        result_lines.append(f"   {result['prediction']}")
    
    result_lines.append("")
    result_lines.append("-" * 80)
    result_lines.append("")
    
    return "\n".join(result_lines)


def format_legacy_prediction_for_result(prediction_json: str, team1: str, team2: str, date: str, venue: str = None) -> str:
    """Format legacy prediction result with AI summary for readable result file."""
    result_lines = []
    result_lines.append(f"LEGACY MATCH PREDICTION: {team1} vs {team2}")
    result_lines.append("-" * 60)
    result_lines.append(f"ğŸ“… Date: {date}")
    if venue:
        result_lines.append(f"ğŸ“ Venue: {venue}")
    result_lines.append("")
    
    try:
        prediction = json.loads(prediction_json)
        if 'prediction' in prediction and 'error' not in prediction:
            winner_team = team1 if prediction['prediction']['winner'] == 'A' else team2
            win_percentage = prediction['prediction']['a_win_pct'] if prediction['prediction']['winner'] == 'A' else prediction['prediction']['b_win_pct']
            
            result_lines.append(f"ğŸ¯ PREDICTION RESULT:")
            result_lines.append(f"   Winner: {winner_team} ({win_percentage}% chance)")
            result_lines.append(f"   Win Probabilities:")
            result_lines.append(f"     â€¢ {team1}: {prediction['prediction']['a_win_pct']}%")
            result_lines.append(f"     â€¢ {team2}: {prediction['prediction']['b_win_pct']}%")
            result_lines.append(f"   Confidence: {prediction.get('confidence', 'unknown').upper()}")
            result_lines.append("")

            # === ADD AI SUMMARY DISPLAY ===
            if 'ai_summary' in prediction and prediction['ai_summary'].get('text'):
                result_lines.append("ğŸ¤– AI ANALYSIS SUMMARY:")
                result_lines.append(f"   {prediction['ai_summary']['text']}")
                result_lines.append("")
            
            # Add explanation
            if 'explanation' in prediction:
                result_lines.append("ğŸ’¡ DETAILED EXPLANATION:")
                result_lines.append(f"   {prediction['explanation']}")
                result_lines.append("")
        else:
            result_lines.append(f"âŒ PREDICTION ERROR:")
            result_lines.append(f"   {prediction.get('error', 'Unknown error occurred')}")
            result_lines.append("")
    except json.JSONDecodeError:
        result_lines.append("âŒ Could not parse prediction data")
        result_lines.append("")
    
    # Add full JSON for reference
    result_lines.append("ğŸ“„ COMPLETE PREDICTION JSON:")
    try:
        parsed_prediction = json.loads(prediction_json)
        formatted_json = json.dumps(parsed_prediction, indent=2, ensure_ascii=False)
        for line in formatted_json.split('\n'):
            result_lines.append(f"   {line}")
    except:
        result_lines.append(f"   {prediction_json}")
    
    result_lines.append("")
    result_lines.append("-" * 80)
    result_lines.append("")
    
    return "\n".join(result_lines) 